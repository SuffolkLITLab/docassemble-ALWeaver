---
modules:
  - .validate_docx_files
---
question: |
  File
fields:
  - file: template_upload
    datatype: file
---
code: |
  verify_docx_fields 
  validate_docx = True
---
code: |
  no_recognized_docx_fields = not (any(field for field in validation_fields if field.reserved) or len(validation_people_list))
---
id: Did you intend to use Mako syntax
question: |
  Did you intend to use Mako syntax?
subquestion: |
  Your DOCX template looks like it is using the Mako syntax ${ }. Usually
  this is an error. DOCX files use Jinja2 syntax, not Mako. You may want to 
  stop here and fix your template by replacing any instances of <%text>`${ }` 
  with `{{ }}`.</%text>
  
  These are the lines that look like they contain Mako syntax:
  
  % for match in mako_matches:
  * ${ match }
  % endfor
  
  If the matches above are "false positives" or you intentionally used
  Mako syntax in your DOCX file, keep on going, but your template
  might not do what you intended. 
  
  Check out the documentation for 
  [python-docx-template](https://docxtpl.readthedocs.io/en/latest/#jinja2-like-syntax) 
  and for [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/) to learn more.
sets: mako_syntax_in_docx  
buttons: 
  - I understand, let me continue: 
      code: |
        mako_syntax_in_docx = True
  - Restart: restart
---
id: did you intend to use PDF variable names
question: |
  Did you intend to use variables that match a PDF variable name?
subquestion: |
  Your DOCX template looks like it is using a variable name that is 
  normally only used in a PDF. You may want to stop here and fix your template 
  by replacing the PDF variable name with the DOCX equivalent.

  These are the lines that look like they contain PDF variable names:

  % for match in pdf_variable_name_in_docx_matches:
  * `${ match[0] }`, did you mean `${ match[1] }`?
  % endfor

  Check out [the labeling
  documentation](https://suffolklitlab.org/docassemble-AssemblyLine-documentation/docs/label_variables)
  and pay attention to the columns labeled `Docassemble / DOCX form`.
sets: warn_pdf_variable_names_in_docx
buttons: 
  - I understand, let me continue: 
      code: |
        warn_pdf_variable_names_in_docx = True
  - Restart: restart
---
id: jinja_exception
event: jinja_exception
question: |
  Your template has invalid Jinja2 syntax
subquestion: |
  The error was:
  
  ${ jinja_errors }
  
  Check out the documentation for 
  [python-docx-template](https://docxtpl.readthedocs.io/en/latest/#jinja2-like-syntax) 
  and for [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/) to learn more.
---
id: confirm-docx-fields
continue button field: verify_docx_fields
question: |
  Validate your template
subquestion: |
  #### Fields
  
  All of the fields in your DOCX ${ template_upload.as_noun("file") } are listed
  in the table below. Confirm that the table looks right.
  
  A **bold** name means that this field is **reserved**.
  Reserved fields are fields that will be handled with a question that
  comes from the AL Question Library. For example:
  
  * Name fields
  * Address fields
  * Basic contact information and court information
  
  If you expect a field to be bold but it isn't, check the field's spelling.

  The **type** of each field is just a guess, based on the field's name.
  You can override the guess later.

  Name (bold if {reserved}) | Type
  --------------------------|------
  % for field in validation_fields.builtins():
  ${ bold(field.variable) } :question: | ${ field.field_type_guess } |
  % endfor
  % for field in validation_fields.custom():
  ${ bold(field.variable) if field.reserved else field.variable } |  ${ field.field_type_guess } | 
  % endfor
  % for field in validation_fields.signatures():
  ${ bold(field.variable) if field.reserved else field.variable } | signature  |
  % endfor
  
  % if len(validation_people_list) > 0:
  :question: Indicates that we think this field could be handled by 
  questions in our question library, so you don't have to write your own 
  questions for it! You can choose whether to use our default questions later.
  % endif
  
  #### Preview  
  Look over the PDF preview of your file below. Make sure that the fonts,
  spacing, and styles look about right. Note: the conditional logic and text
  your user enters can change the formatting by moving text to a new line. You
  will also see the placeholder variable names unchanged in this preview.
  
  In DOCX templates, for safety, we recommend that you use the standard
  [Microsoft Core Fonts for the
  Web](https://en.wikipedia.org/wiki/Core_fonts_for_the_Web), including Arial
  and Times New Roman, as the standard fonts. It is possible to install additional
  fonts but it may be complex.
  
  If spacing or other formatting looks wrong, try editing your DOCX files in
  [LibreOffice](https://www.libreoffice.org/) and get it looking right there.
  
  % for document in template_upload:  
  ${ collapse_template(document.preview_template) }

  % endfor

fields:
  - no label: docx_fields_checkup_status
    datatype: checkboxes
    choices:
      - All of my fields are listed in the table above: all_fields_present
      - There are no unexpected fields in the table: no_unexpected_fields
      - All the reserved fields are bolded as I expected: correct_reserved_fields    
      - The fonts and styles in the preview look okay OR I am comfortable fixing them later: fonts_okay
        help: |
          Note: use the Microsoft Core Fonts for the Web to be safe.
    minlength: 4
    validation messages:
      minlength: |
        You must select all of the checkboxes to keep going.
    none of the above: False
terms:
  - reserved: |
      Means there is a built-in question for this field.
css: |
  <style>
  .question-confirm-docx-fields div.container {
    max-width: 2000px;
  }  
  </style>
---
template: preview_docx_file
subject: |
  Preview your DOCX template
content: |
  ${ pdf_concatenate(template_upload) }
---
only sets:
  - validation_fields
  - validation_people_list
code: |
  validation_people_list = all_fields.get_person_candidates(custom_only=True)
  validation_fields = all_fields.copy_deep("validation_fields")

  for field in validation_fields:
    if field.source_document_type == "docx":
      field.reserved = is_reserved_docx_label(field.variable) or field.variable in people_list
    elif field.source_document_type == "pdf":
      field.reserved = is_reserved_label(field.variable)
    
  validation_fields.mark_people_as_builtins(people_list)